---
AWSTemplateFormatVersion: '2010-09-09'

Description: Launch a custom Bootstrap

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
    -
      Label:
        default: "AWS Configuration"
      Parameters:
        - SubnetName
        - HostedZoneID
    -
      Label:
        default: "Top-level environment configuration"
      Parameters:
        - VpcName
        - GitSSHPrivateKey

Parameters:
  HostedZoneID:
    Description: Hosted Zone ID
    Type: AWS::Route53::HostedZone::Id

  GitSSHPrivateKey:
      NoEcho: 'true'
      Description: Private SSH key to access repositories
      Type: String
  
  RepoURL:
      Description: Full ssh URL to configuration repository (starting with ssh://)
      Type: String

Resources:

  # SSM SecureString parameter for SSH Key
  MySSMSecureString:
    Type: Custom::SSMSecureString
    Properties:
      ServiceToken: !GetAtt SSMSecureStringCustomResource.Arn
      Name: '/my/securestring/data'
      Value: !Ref GitSSHPrivateKey
      Description: 'Dummy'

  # Git Repo URL for cloning
  MyRepoUrl:
    Type: Custom::RepoURL
    Properties:
      ServiceToken: !GetAtt RepoURLCustomResource.Arn
      Name: 'RepoURL'
      Value: !Ref RepoURL
    DependsOn: MySSMSecureString

  # Custom resource to create/update/delete SSM securestring parameters
  SSMSecureStringCustomResource:
    Type: AWS::Lambda::Function
    Properties:
      Handler: "index.handler"
      Runtime: python3.7
      Timeout: 30
      Role: !GetAtt LambdaSSMSecureStringExecutionRole.Arn
      Code:
        ZipFile: |
          import json
          import boto3
          import cfnresponse
          import logging
          import base64

          def parameter_exists(name):
            response = boto3.client('ssm').describe_parameters(
                ParameterFilters=[{
                    'Key': 'Name',
                    'Values': [
                        name
                    ]
                }]
            )
            return len(response["Parameters"]) > 0
                  
          def handler(event, context):
            logger = logging.getLogger()
            logger.setLevel(logging.INFO)

            # Get SSM parameter name
            name = event["ResourceProperties"]["Name"]
    
            # initialize our response
            response_data = {}
            response_status = cfnresponse.FAILED
            
            logger.info('Received event: {}'.format(json.dumps(event)))

            try:
              ssm=boto3.client('ssm')
            except Exception as e:
              logger.info('boto3.client failure: {}'.format(e))
              cfnresponse.send(event, context, cfnresponse.FAILED, response_data)
            
            if event['RequestType'] in ['Create', 'Update']:
              if event["RequestType"] == "Create" and parameter_exists(name):
                cfnresponse.send(event, context, cfnresponse.FAILED, response_data)

              response = boto3.client('ssm').put_parameter(
                Name=name,
                Description=event["ResourceProperties"]["Description"],
                Value=event["ResourceProperties"]["Value"],
                Type="SecureString",
                #KeyId=event["ResourceProperties"]["KeyId"],
                Overwrite=True
              )
              print(event["ResourceProperties"]["Value"])
              logger.info("Successfully stored parameter {}".format(name))

              cfnresponse.send(event, context, cfnresponse.SUCCESS, response, name)
              
            elif event['RequestType'] == 'Delete':
              boto3.client('ssm').delete_parameter(
                Name=event["PhysicalResourceId"],
              )
              logger.info("Successfully deleted parameter: {}".format(name))
              cfnresponse.send(event, context, cfnresponse.SUCCESS, None, name)
              

  # execution role for the SSM secure string custom resource function
  LambdaSSMSecureStringExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - lambda.amazonaws.com
          Action:
          - sts:AssumeRole
      Path: "/"
      Policies:
      - PolicyName: root
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
            Resource: arn:aws:logs:*:*:*
          - Effect: Allow
            Action:
              - ssm:PutParameter
              - ssm:GetParameter
              - ssm:DescribeParameters
              - ssm:DeleteParameter
            Resource: "*"

# Custom resource to for handling the Git Repo URL
  RepoURLCustomResource:
    Type: AWS::Lambda::Function
    Properties:
      Handler: "index.handler"
      Environment:
        Variables:
          HOME: "/tmp"
      Runtime: python3.7
      Layers: [!Sub "arn:aws:lambda:${AWS::Region}:553035198032:layer:git:6","arn:aws:lambda:eu-central-1:381251817649:layer:Jinja2:2"]
      Timeout: 30
      Role: !GetAtt LambdaRepoURLExecutionRole.Arn
      Code:
        ZipFile: !Sub |
          from __future__ import print_function
          from distutils.dir_util import copy_tree
          from botocore.vendored import requests
          from jinja2 import Template
          import os,subprocess,json,boto3,logging,jinja2,urllib,re
          def handler(event,context):
            n='/';m='git %s %s';l=' && ';k='/tmp/template-environment-configuration';j='-rf';i='rm';h='eu-central-1';g='ssm';R='application/';Q='\n';P=True;O='/tmp/id_rsa';N='RequestType';F=context;A=event;B=logging.getLogger();B.setLevel(logging.INFO);B.info('Received event: {}'.format(json.dumps(A)));C=A['ResourceProperties']['Name'];G={}
            try:K=boto3.client(g)
            except Exception as S:B.info('boto3.client failure: {}'.format(S));send(A,F,FAILED,G)
            if A[N]=='Create':
              T='1234567890';o='0987654321';U='test';D=h;p='demo';q='https://jenkins.com';r='https://proxy.com';s='vpc-123456';V='https://github.com/kentrikos/template-environment-configuration.git';W='git@github.com:heggenu/lambda-git-push.git';X='clone --depth 1 -b jinja_templating --single-branch';Y='remote add origin';subprocess.run([i,j,k]);subprocess.run([i,j,O]);os.environ['GIT_SSH_COMMAND']='ssh -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -i /tmp/id_rsa';K=boto3.client(g);Z=K.get_parameter(Name='/my/securestring/data',WithDecryption=P);E=Z['Parameter']['Value'];a=re.search('^(-----BEGIN ([^-]+)-----)',E).group(0);b=re.search('(-----END ([^-]+)-----)',E).group(0);H=re.sub('^\\s*(?:\\-+(?:.*?)\\-+)?\\s*((?:[A-Za-z0-9\\+\\/]\\s?)+={0,2})\\s*(?:\\-+(?:.*?)\\-+)?\\s*$','\\g<1>',E);H=H.replace(' ',Q);E=a+Q+H+Q+b+'\n ';L=open(O,'w+');L.write(E);L.close();subprocess.run(['chmod','700',O]);t=subprocess.check_output(l.join(['git config --global --add user.email "example@example.com"','git config --global --add user.name "example"','cd /tmp',m%(X,V)]),stderr=subprocess.STDOUT,shell=P).decode();os.chdir(k);u=os.getcwd();D=h;I='operations/region';J='operations/'+D+n;copy_tree(I,J);I='application/region';J=R+D+n;copy_tree(I,J);c=R+D+'/terraform.template.tfvars'
              with open(c)as d:e=Template(d.read())
              f=e.render(application_aws_account_number=T,environment_type=U);M=open(R+D+'/terraform.tfvars','w');M.write(f);M.close();v=subprocess.check_output(l.join(['cd /tmp/template-environment-configuration','rm -rf .git','git init',m%(Y,W),'git add .','git commit -m initial']),stderr=subprocess.STDOUT,shell=P).decode();B.info('Successfully retrieved parameter {}'.format(C));send(A,F,SUCCESS,G,C)
            if A[N]=='Update':B.info('Successfully updated parameter {}'.format(C));send(A,F,SUCCESS,G,C)
            elif A[N]=='Delete':B.info('Successfully deleted parameter: {}'.format(C));send(A,F,SUCCESS,None,C)
          SUCCESS='SUCCESS'
          FAILED='FAILED'
          def send(event,context,responseStatus,responseData,physicalResourceId=None,noEcho=False):
            K='LogicalResourceId';J='RequestId';I='StackId';D=context;B=event;E=B['ResponseURL'];print(E);A={};A['Status']=responseStatus;A['Reason']='See the details in CloudWatch Log Stream: '+D.log_stream_name;A['PhysicalResourceId']=physicalResourceId or D.log_stream_name;A[I]=B[I];A[J]=B[J];A[K]=B[K];A['NoEcho']=noEcho;A['Data']=responseData;C=json.dumps(A);print('Response body:\n'+C);F={'content-type':'','content-length':str(len(C))}
            try:G=requests.put(E,data=C,headers=F);print('Status code: '+G.reason)
            except Exception as H:print('send(..) failed executing requests.put(..): '+str(H))
                
    DependsOn: SSMSecureStringCustomResource

  # execution role for the SSM secure string custom resource function
  LambdaRepoURLExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - lambda.amazonaws.com
          Action:
          - sts:AssumeRole
      Path: "/"
      Policies:
      - PolicyName: root
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
            Resource: arn:aws:logs:*:*:*
          - Effect: Allow
            Action:
              - ssm:GetParameter
            Resource: "*"

# Outputs - Display function output

Outputs:
  AWSRegion:
    Value: !Ref "AWS::Region"
  
  AWSAccount:
    Value: !Ref "AWS::AccountId"

  TestURL:
    Value: "https://eu-central-1.console.aws.amazon.com/cloudformation/home?region=eu-central-1#/stacks/quickcreate?templateUrl=https%3A%2F%2Fkentrikosdemo.s3.eu-central-1.amazonaws.com%2FCustomBootstrap.yaml&stackName=henriktest&param_HostedZoneID=ABC123&param_RepoURL=gitssh"
